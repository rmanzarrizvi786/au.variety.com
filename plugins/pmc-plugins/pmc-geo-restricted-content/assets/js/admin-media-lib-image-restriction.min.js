!function($){({restrictionTypeSelector:".compat-field-restricted_image_type input",restrictedNoticeSelector:".attachment-info .restricted-notice",captionSelector:'span[data-setting="caption"] textarea',creditSelector:"form.compat-item .compat-field-image_credit input",currentPostId:$("#post_ID").val()?$("#post_ID").val():0,attachmentModel:null,init:function(){function restrictionTypeChangeEvent(){_self.updateNotice()}function updateAttachmentListenerEvent(e){["selection:single","change:loaded"].includes(e)?(_self.updateAttachmentListener(null),_self.updateNotice()):e.id&&(_self.updateAttachmentListener(e.id),_self.updateNotice())}var _self=this;wp.media.view.Modal.prototype.on("open",function(e){$(function(){var selection,frame=wp.media.frame,id=_self.getAttachmentIdFromUrl();id&&_self.updateAttachmentListener(id),_self.updateNotice(),$(frame.$el).on("change",_self.restrictionTypeSelector,restrictionTypeChangeEvent),wp.media.frame.on("refresh",updateAttachmentListenerEvent),void 0===frame.state()||void 0!==(selection=frame.state().get("selection"))&&selection.on("all",updateAttachmentListenerEvent)})}),wp.media.view.Modal.prototype.on("close",function(e){var selection,frame=wp.media.frame;$(frame.$el).off("change",_self.restrictionTypeSelector,restrictionTypeChangeEvent),frame.off("refresh",updateAttachmentListenerEvent),void 0===frame.state()||void 0!==(selection=frame.state().get("selection"))&&selection.off("all",updateAttachmentListenerEvent)})},getAttachmentIdFromUrl:function(){var params=this.getParams();return params.item?params.item:null},updateAttachmentListener:function(id){var _self=this,view=wp.media.view.AttachmentCompat.prototype,selection=wp.media.frame.state().get("selection");if(_self.attachmentModel&&view.stopListening(_self.attachmentModel),id)_self.attachmentModel=wp.media.attachment(id);else{if(void 0===selection||!selection.single())return;_self.attachmentModel=selection.single()}view.listenTo(_self.attachmentModel,"change input",function(){_self.verifyImageCredits(),_self.updateNotice()})},getParams:function(){for(var pair,params={},items=window.location.search.substring(1).split("&"),i=0;i<items.length;i++)params[(pair=items[i].split("="))[0]]=decodeURIComponent(pair[1]);return params},updateNotice:function(){var $frame=$(wp.media.frame.$el),$restrictedNotice=$frame.find(this.restrictedNoticeSelector);if(0===$restrictedNotice.length&&($restrictedNotice=$("<div>").addClass("restricted-notice").hide(),$frame.find(".attachment-info .details").length?$frame.find(".attachment-info .details").prepend($restrictedNotice):$(".attachment-info .details").prepend($restrictedNotice)),null!==this.attachmentModel&&void 0!==this.attachmentModel.attributes.compat){var imageRestrictedTypeVal=$(this.attachmentModel.attributes.compat.item).find(this.restrictionTypeSelector).filter(":checked").val();switch(imageRestrictedTypeVal){case"single_use":case"site_restricted":var notice={single_use:{class:"restricted-single-use-notice",text:"This is a Single Use Image - restricted to use for a specific post."},site_restricted:{class:"site-restricted-notice",text:"This image is restricted to use on this site only."}}[imageRestrictedTypeVal];$restrictedNotice.attr("class",notice.class+" restricted-notice").text(notice.text).show();break;default:$restrictedNotice.hide().attr("class","restricted-notice").text("")}this.validateImageRestriction()}},validateImageRestriction:function(){var singleUsePost,$insertButton=$(wp.media.frame.$el).find(".media-toolbar button.media-button");$insertButton.css("visibility","visible").show(),null!==this.attachmentModel&&((singleUsePost=$(this.attachmentModel.attributes.compat.item).find(this.restrictionTypeSelector).filter(":checked").data("singleusepost"))&&parseInt(this.currentPostId,10)!==parseInt(singleUsePost,10)?($insertButton.attr("disabled",!0),$insertButton.css("visibility","hidden")):($insertButton.attr("disabled",!1),$insertButton.css("visibility","visible")))},verifyImageCredits:function(){var captionText,creditText,id,data,_self=this,$frame=$(wp.media.frame.$el),$credit=$frame.find(_self.creditSelector),$caption=$frame.find(_self.captionSelector),$restrictionType=$frame.find(_self.restrictionTypeSelector),regex=/\bap\b|\bassociated press\b/i;$restrictionType.length&&!0!==$restrictionType[2].checked&&(captionText=$caption.val(),creditText=$credit.val(),null===regex.exec(captionText)&&null===regex.exec(creditText)||($restrictionType.eq(2).attr("checked",!0),_self.attachmentModel&&(id=_self.attachmentModel.attributes.id,(data={attachments:{}}).attachments[id.toString()]={restricted_image_type:"single_use"},_self.attachmentModel.saveCompat(data).done(function(res){res.caption=captionText,res.image_credit=creditText,_self.attachmentModel.save(res)}))))}}).init()}(jQuery);