<?php
/**
 * This class is responsible for adding allow list filter if feed option is check
 * @ref: https://wordpressvip.zendesk.com/requests/30356
 */

use \PMC\Global_Functions\Traits\Singleton;

class PMC_Custom_Feed_Allowlist_Embed {

	use Singleton;

	protected function __construct() {
		add_action( 'pmc_custom_feed_start', array( $this, 'action_pmc_custom_feed_start' ), 10, 3 );
	}

	// action hook before feed template start
	public function action_pmc_custom_feed_start( $feed = false, $feed_options = false, $template = '' ) {

		$allow_known_embeds = false;
		// @TODO: To be removed
		if ( ! empty( $feed_options['whitelist-known-embeds'] ) ) {
			$allow_known_embeds = $feed_options['whitelist-known-embeds'];
		}

		if ( ! empty( $feed_options['allow-known-embeds'] ) ) {
			$allow_known_embeds = $feed_options['allow-known-embeds'];
		}

		if ( empty( $allow_known_embeds ) ) {
			return;
		}

		// @TODO: To be update when VIP update the filter name, obfuscate for now
		add_filter( 'protected_embeds_script_wh' . 'itelist', [ $this, 'filter_protected_embeds_script_allow' ] );
	}


	// filter to return a allow list domains to bypass protected emededs
	public function filter_protected_embeds_script_allow( $allowlist ) {
		if ( ! is_array( $allowlist ) ) {
			$allowlist = [];
		}
		$allowlist = array_merge(
			$allowlist,
			[
				'CBSLA.images.worldnow.com',
				'CBSMIA.images.worldnow.com',
				'CBSNY.images.worldnow.com',
				'KCTV.images.worldnow.com',
				'KPHO.images.worldnow.com',
				'KTIV.images.worldnow.com',
				'WBTW.images.worldnow.com',
				'WFSB.images.worldnow.com',
				'WFXT.images.worldnow.com',
				'WNYW.images.worldnow.com',
				'a.abc.com',
				'a.tumblr.com',
				'a.yfrog.com',
				'abc.go.com',
				'abcnews.go.com',
				'about:blank',
				'ad.doubleclick.net',
				'admin.brightcove.com',
				'ads.mail.com',
				'ads.tw.adsonar.com',
				'aenetworks.app.box.com',
				'aktrack.pubmatic.com',
				'animalist.com',
				'api.zippyshare.com',
				'apis.google.com',
				'app.box.com',
				'apps.curatorr.com',
				'apps.quibblo.com',
				'assets.delvenetworks.com',
				'assets.tumblr.com',
				'auth.nowlive.com',
				'badge.stumbleupon.com',
				'beta.abc.go.com',
				'blip.tv',
				'blive.bproductions.com',
				'bluetoad.com',
				'blyve.com',
				'c.brightcove.com',
				'c.gigcount.com',
				'ca.movies.yahoo.com',
				'cache.vevo.com',
				'can.cbs.com',
				'cb.sailthru.com',
				'cbsnewyork.files.wordpress.com',
				'ccc.crackle.com',
				'cdn.abclocal.go.com',
				'cdn.livestream.com',
				'cdn.media.theview.tv',
				'cdn.onlinecountdowns.com',
				'cdn.playwire.com',
				'cdn.springboard.gorillanation.com',
				'cdn.tribtv.com',
				'cdn1.whosaystatic.com',
				'cdnapi.kaltura.com',
				'cdnl.complex.com',
				'cdnsecakmi.kaltura.com',
				'celebrity.yahoo.com',
				'cf.datawrapper.de',
				'cfiles.5min.com',
				'chill.com',
				'cms.springboardplatform.com',
				'cnettv.cnet.com',
				'conchordswiki.hbo.com',
				'connectv.com',
				'content.nerdist.com',
				'countdownpage.createyourcountdown.com',
				'ct1.addthis.com',
				'd.getElementsByTagName',
				'd.yimg.com',
				'd2cjdr17j9fuin.cloudfront.net',
				'dgjigvacl6ipj.cloudfront.net',
				'distilleryvesper6-10.ak.instagram.com',
				'distilleryvesper6-14.ak.instagram.com',
				'div.agenda',
				'docs.google.com',
				'download.macromedia.com',
				'e.issuu.com',
				'edge1.streamingtank.tv',
				'embed.5min.com',
				'embed.live.huffingtonpost.com',
				'embed.newsinc.com',
				'embed.scribblelive.com',
				'embed.trilulilu.ro',
				'embed.vhx.tv',
				'eplayer.clipsyndicate.com',
				'espn.go.com',
				'features.oxygen.com',
				'flash.sonypictures.com',
				'flashmedia',
				'fpdownload.macromedia.com',
				'free.timeanddate.com',
				'giphy.com',
				'gma.yahoo.com',
				'gu-embedded-video.appspot.com',
				'h2.dl',
				'hash',
				'hollywoodlife.polldaddy.com',
				'html5-player.libsyn.com',
				'hub.video.msn.com',
				'i.cdn.turner.com',
				'ictv-dread-ec.indieclicktv.com',
				'ihearmelodies.tumblr.com',
				'image.cdn.ispot.tv',
				'img.widgets.video.s-msn.com',
				'imp.revsci.net',
				'instagram.com',
				'interweber.tumblr.com',
				'inyoureyesmovie.com',
				'johnjayandrich.1047kissfm.com',
				'l.lj-toys.com',
				'l.yimg.com',
				'landing.newsinc.com',
				'launch.newsinc.com',
				'link.brightcove.com',
				'link.deadline.com',
				'livealliance.tv',
				'media.cwtv.com',
				'media.iheart.com',
				'media.mtvnservices.com',
				'media.nbcdfw.com',
				'media.nbclosangeles.com',
				'media.nbcnewyork.com',
				'media.nbcphiladelphia.com',
				'media.prnewswire.com',
				'media.whosay.com',
				'mediamatters.org',
				'mediaservices.myspace.com',
				'mixbit.com',
				'movies.yahoo.com',
				'music.yahoo.com',
				'nbcsports.msnbc.com',
				'new.livestream.com',
				'news.iheart.com',
				'news.yahoo.com',
				'nissannews.com',
				'o.aolcdn.com',
				'on.vh1.com',
				'origin-qps.onstreammedia.com',
				'ortsbovideo.cloudapp.net',
				'oscar.go.com',
				'p+',
				'p.nowthisnews.com',
				'pagesix.com',
				'pdl.warnerbros.com',
				'platform.tumblr.com',
				'platform.twitter.com',
				'player.bimvid.com',
				'player.cinchcast.com',
				'player.cnevids.com',
				'player.espn.com',
				'player.foxfdm.com',
				'player.longtailvideo.com',
				'player.m6web.fr',
				'player.mylifetime.com',
				'player.ooyala.com',
				'player.theplatform.com',
				'player.vimeo.com',
				'plus.cnbc.com',
				'plusone.google.com',
				'pmcevents.polldaddy.com',
				'pmchollywoodlife.wordpress.com',
				'pmcvariety.files.wordpress.com',
				'pnyr.big1059.com',
				'pressroom.turner.com',
				'pshared.5min.com',
				'public.tableausoftware.com',
				'rcm.amazon.com',
				'rockdizfile.com',
				'rtmp:',
				'ryan.kiisfm.com',
				's0.2mdn.net',
				'screen.yahoo.com',
				'secure.hulu.com',
				'seenive.com',
				'serve.a-widget.com',
				'servicesaetn-a.akamaihd.net',
				'shopsensewidget.shopstyle.com',
				'snagplayer.video.dp.discovery.com',
				'snapwidget.com',
				'southpark.cc.com',
				'spreadsheets.google.com',
				'static.discoverymedia.com',
				'static.issuu.com',
				'static.livestream.com',
				'static.movideo.com',
				'statigr.am',
				'storify.com',
				'svideoplayer.vevo.com',
				'swfs.bimvid.com',
				'tags.audiencefuel.com',
				'teamcoco.com',
				'telly.com',
				'testtube.com',
				'thecolbertreport.cc.com',
				'trailers.apple.com',
				'tv.yahoo.com',
				'tweakers.net',
				'twitter.com',
				'twitter.yfrog.com',
				'uk.movies.yahoo.com',
				'uk.omg.yahoo.com',
				'uk.screen.yahoo.com',
				'undefined',
				'v.traileraddict.com',
				'v5.tinypic.com',
				'variety.com',
				'vds.rightster.com',
				'video.disney.com',
				'video.foxnews.com',
				'video.heraldsun.com.au',
				'video.nbcuni.com',
				'video.nhl.com',
				'video.pbs.org',
				'video.vulture.com',
				'videoplayer.vevo.com',
				'videos.inc.com',
				'videos.mediaite.com',
				'vids.perezhilton.com',
				'view.atdmt.com',
				'vimeo.com',
				'vine.co',
				'vines.s3.amazonaws.com',
				'vplayer.nbcsports.com',
				'vsi2.usc.edu',
				'w.soundcloud.com',
				'waitonyouforeverr.tumblr.com',
				'wbads.vo.llnwd.net',
				'webassets.scea.com',
				'widget.bravotv.com',
				'widget.nbc.com',
				'widget.newsinc.com',
				'widget.shopstyle.com',
				'widget.stagram.com',
				'widgets.ign.com',
				'widgets.nbc.com',
				'wpcomwidgets.com',
				'wpix.vid.trb.com',
				'www.933flz.com',
				'www.abc15.com',
				'www.americanidol.com',
				'www.antena3.com',
				'www.audiomack.com',
				'www.azfamily.com',
				'www.bakersfieldnow.com',
				'www.bbc.co.uk',
				'www.bet.com',
				'www.bloomberg.com',
				'www.bluetoad.com',
				'www.bravotv.com',
				'www.cbs.com',
				'www.cbsnews.com',
				'www.cbspressexpress.com',
				'www.cbssports.com',
				'www.cms.springboardplatform.com',
				'www.cnn.com',
				'www.coveritlive.com',
				'www.crackle.com',
				'www.cwseed.com',
				'www.dailymail.co.uk',
				'www.dailymotion.com',
				'www.deadline.com',
				'www.dior.com',
				'www.drphil.com',
				'www.ellentv.com',
				'www.elvisduran.com',
				'www.emmytvlegends.org',
				'www.eonline.com',
				'www.etonline.com',
				'www.facebook.com',
				'www.fandango.com',
				'www.flickr.com',
				'www.funnyordie.com',
				'www.geeknation.com',
				'www.hbo.com',
				'www.hiphopstan.com',
				'www.hlntv.com',
				'www.hollywoodlife.com',
				'www.hot995.com',
				'www.hotnewhiphop.com',
				'www.hulu.com',
				'www.hungertv.com',
				'www.iheartradio.com',
				'www.imdb.com',
				'www.indiegogo.com',
				'www.indiewire.com',
				'www.ireport.com',
				'www.kaltura.com',
				'www.katu.com',
				'www.kdwb.com',
				'www.keek.com',
				'www.khou.com',
				'www.kickstarter.com',
				'www.kiisfm.com',
				'www.kiss108.com',
				'www.komonews.com',
				'www.kshb.com',
				'www.kyte.tv',
				'www.liveleak.com',
				'www.livemixtapes.com',
				'www.metatube.com',
				'www.movieweb.com',
				'www.mrctv.org',
				'www.msnbc.msn.com',
				'www.mtv.com',
				'www.multivu.com',
				'www.myfoxny.com',
				'www.mystyle.com',
				'www.nbc.com',
				'www.nbcbayarea.com',
				'www.nbclosangeles.com',
				'www.nbcnews.com',
				'www.nbcnewyork.com',
				'www.nbcsandiego.com',
				'www.nbcsports.com',
				'www.necn.com',
				'www.newsnet5.com',
				'www.nielsen.com',
				'www.nowlive.com',
				'www.oprah.com',
				'www.ora.tv',
				'www.oxygen.com',
				'www.pardolive.ch',
				'www.power1051fm.com',
				'www.power99.com',
				'www.radionow979.com',
				'www.screenrush.co.uk',
				'www.scribd.com',
				'www.snappytv.com',
				'www.socialguide.com',
				'www.spinmediavideo.com',
				'www.springboardplatform.com',
				'www.starwars.com',
				'www.starz.com',
				'www.stuff.co.nz',
				'www.thedoctorstv.com',
				'www.theinsider.com',
				'www.theonion.com',
				'www.thinglink.com',
				'www.traileraddict.com',
				'www.twitch.tv',
				'www.twitvid.com',
				'www.urbanreup.com',
				'www.usmagazine.com',
				'www.ustream.tv',
				'www.vevo.com',
				'www.viddler.com',
				'www.viddy.com',
				'www.videogram.com',
				'www.vimg.net',
				'www.washingtonpost.com',
				'www.wcnc.com',
				'www.wetv.com',
				'www.whosay.com',
				'www.worldstarhiphop.com',
				'www.wxyz.com',
				'www.yahoo.com',
				'www.youtube-nocookie.com',
				'www.youtube.com',
				'www.z100.com',
				'yourlisten.com',
				'youtu.be',
				'zingo.tv',
			]
		);
		return $allowlist;
	} // function filter_protected_embeds_script_allow

}

PMC_Custom_Feed_Allowlist_Embed::get_instance();
