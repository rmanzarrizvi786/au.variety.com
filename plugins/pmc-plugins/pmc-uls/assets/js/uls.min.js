/* global pmc */
void 0===String.prototype.includes&&(String.prototype.includes=function(e){return-1!=this.indexOf(e)})
var uls=uls||{ping_back_grace_minute:5,fast:0,url:"https://uls."+document.location.hostname.match(/([^.]+\.[^.]+$)/)[0],cookie_prefix:"uls3",is_go:0}
uls.session=uls.session||{get:function(e,t){var o=pmc.cookie.get(uls.cookie_prefix+"_"+e)
return o||void 0!==t&&t},can_access:function(e){if(!uls.session.get("user_id"))return!1
var t=uls.session.get("entitlement")
return!!t&&t.includes(e)},is_bypass:function(){return uls.session.get("bypass")},is_valid:function(){return 0<this.get("group_id")||0<this.get("user_id")}},uls.caching=uls.caching||{login:function(){this.call()},update:function(){this.call()},logout:function(){this.call({doing:"logout"})},call:function(e){void 0!==uls.is_go&&"1"===uls.is_go&&jQuery.ajax({async:!1,type:"GET",url:ajaxurl+"?action=pmc_uls_do_cache_segment_ajax_callback",cache:!1,xhrFields:{withCredentials:!0},data:e})}},uls.api=uls.api||{endpoint:"/api/v3/",endpoint_v2:"/api/v2/",overlay_count:0,set_overlay_processing:function(e){var t=this,o=jQuery("#uls_overlay_ajax_loading")
e?(t.overlay_count+=1,o.length||(o=jQuery("<div></div>").attr("id","uls_overlay_ajax_loading"),jQuery("body").append(o)),jQuery(o).show()):o.length&&(t.overlay_count-=1,t.overlay_count<=0&&(t.overlay_count=0,jQuery(o).hide()))},ping:function(e){var t=this,o=""
"object"==typeof e&&void 0!==e.fast&&e.fast&&(o="/fast"),t.call("GET",t.endpoint+"session/ping"+o,{show_busy:!1,data:"object"==typeof e&&"object"==typeof e.data?e.data:null,error:function(){if("object"==typeof e&&"function"==typeof e.error)try{e.error.apply(t,[])}catch(e){}},success:function(o){if("object"==typeof o&&void 0!==o.refresh&&o.refresh&&uls.caching.update(),"object"!=typeof e||"function"!=typeof e.success)"object"==typeof o&&void 0!==o.refresh&&o.refresh&&window.location.reload()
else try{e.success.apply(t,[o])}catch(e){}}})},otll:function(e,t){var o=this
o.call("GET",o.endpoint_v2+"otll/user/"+e,{success:function(e){try{t.success.apply(o,[e])}catch(e){window.console.log(e)}},error:function(e){try{t.error.apply(o,[e])}catch(e){window.console.log(e)}}})},logout:function(e){var t=this
t.call("GET",t.endpoint+"session/destroy",{success:function(){if(uls.caching.logout(),"object"!=typeof e||"function"!=typeof e.success)window.location.reload()
else try{e.success.apply(t)}catch(e){}}})},login:function(e,t,o,i){var s=this
e&&t&&s.call("POST",s.endpoint+"session/authenticate",{data:{username:e,password:t,rememberme:o,delete_session:pmc.get_object_property(i,"delete_session",0)},error:function(){if("object"==typeof i&&"function"==typeof i.error)try{i.error.apply(s,[])}catch(e){}},success:function(e){try{if(!e.error&&e.user_id){if(uls.caching.login(),"object"==typeof i&&"function"==typeof i.success){try{i.success.apply(s,[e])}catch(e){}return}if(window.location.pathname.search(/\/login/)>-1)return void(window.location=window.location.pathname.replace(/login.*/,""))
window.location.reload()}}catch(e){}if("object"==typeof i&&"function"==typeof i.error)try{i.error.apply(s,[e])}catch(e){}}})},get_provider:function(e,t){var o=this
e&&o.call("GET",o.endpoint+"subscription/provider/"+e,{error:function(e){try{t.apply(null,[e])}catch(e){}},success:function(e){try{t.apply(null,[e])}catch(e){}}})},call:function(e,t,o){if(!uls.url)return!1
var i=this,s="object"==typeof o&&void 0!==o.data?o.data:null,n="object"==typeof o&&void 0!==o.contentType?o.contentType:"application/x-www-form-urlencoded"
"application/json"===n&&(s=JSON.stringify(s)),jQuery.ajax({async:!0,type:e,url:uls.url+t,cache:!1,xhrFields:{withCredentials:!0},data:s,contentType:n,beforeSend:function(){("object"!=typeof o||void 0===o.show_busy||o.show_busy)&&i.set_overlay_processing(!0)},complete:function(){("object"!=typeof o||void 0===o.show_busy||o.show_busy)&&i.set_overlay_processing(!1)},error:function(e,t,s){if("object"==typeof o&&"function"==typeof o.error)try{o.error.apply(i,[e,t,s])}catch(e){}},success:function(e,t,s){if("object"==typeof o&&"function"==typeof o.success)try{o.success.apply(i,[e,t,s])}catch(e){}}})}},uls.bluetoad=uls.bluetoad||{access_issue:function(e,t,o,i){void 0!==e&&e||(e="l"),void 0!==t&&t&&(void 0!==o&&o||(o=5153),void 0!==i&&i||(i="bluetoad.com"),uls.api.ping({data:{token:!0},success:function(s){try{if(s&&s.valid&&s.username&&s.token){var n=jQuery("<form />",{id:"bluetoad-form",action:"https://www.bluetoad.com/publication/logincheck.php",method:"POST"}).append(jQuery("<input />",{name:"registration",type:"hidden",value:0}),jQuery("<input />",{name:"pub_id",type:"hidden",value:o}),jQuery("<input />",{name:"m",type:"hidden",value:t}),jQuery("<input />",{name:"l",type:"hidden",value:"l"===e?1:0}),jQuery("<input />",{name:"i",type:"hidden",value:"l"!=e?e:0}),jQuery("<input />",{name:"reader_login",type:"hidden",value:s.username}),jQuery("<input />",{name:"reader_password",type:"hidden",value:s.token}),jQuery("<input />",{name:"targ_dom",type:"hidden",value:i}))
jQuery("body").append(n),jQuery(n).submit(),jQuery(n).remove()}}catch(e){}}}))}},uls.message=uls.message||{mapping:{default:"You have entered an incorrect Username or password, please try again.",contact_support:"Please contact support.",inactive:"Your account is inactive.",subscription_expired:"Your account is expired.",subscription_invalid:"There is some issue with your subscription.",has_session:'You are logged in to too many devices. To clear all your sessions, re-enter your credential and click on "Clear Session"',group_access_limit_reached:"Your organization's concurrent seat limit has been reached. You won't have access to subscriber only content until someone else's session expires. Please try again in a few minutes.",group_subscription_expired:"Your organization's subscription has expired or is inactive.",group_subscription_invalid:"There is some issue with your organization's subscription.",contact_site_license_admin:"Please contact your site license administrator at [support_email] for support."},replace_variables:function(e,t){var o=["support_email"]
return jQuery(o).each(function(o,i){var s=pmc.get_object_property(e,i,!1)
if(s){var n=new RegExp("\\["+i+"\\]")
t=t.replace(n,s)}}),t},build_text:function(e,t){var o=pmc.get_object_property(e,"reason",!1),i=pmc.is_empty(t)?this.mapping.default:t
switch(o){case"inactive":case"subscription_expired":case"subscription_invalid":i=this.mapping[o]+" "+this.mapping.contact_support
break
case"has_session":case"group_access_limit_reached":i=this.mapping[o]
break
case"group_subscription_expired":case"group_subscription_invalid":i=this.mapping[o],void 0!==e.support_email&&(i+=" "+this.mapping.contact_site_license_admin)}return this.replace_variables(e,i)},build_dom_element:function(e,t){return jQuery("<div/>").append(this.build_text(e,t))}},jQuery(document).ready(function(){var e=uls.session.get("session_exp"),t=uls.session.get("autologin")
if(e||t)try{var o=parseInt(uls.fast),i=e?(Date.parse(e.replace(/\+/g," "))-Date.now())/1e3/60:0,s=i<uls.ping_back_grace_minute
uls.session.get("entitlement")||(o=!1,s=!0),s&&uls.api.ping({fast:o,success:function(e){try{if(void 0===e)return
void 0!==e.error&&e.error&&pmc.hooks.do_action("uls.ping.error",e),void 0!==e.refresh&&e.refresh&&pmc.hooks.do_action("uls.ping.refresh",e)}catch(e){}}})}catch(e){}})
